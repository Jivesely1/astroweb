---
import MainLayout from '../../layouts/MainLayout.astro';
import { client, urlFor } from '../../lib/sanity';
import { PortableText } from 'astro-portabletext';

export async function getStaticPaths() {
  const posts = await client.fetch(`
    *[_type == "post"]{
      slug { current }
    }
  `);

  return posts.map(post => ({
    params: { slug: post.slug.current }
  }));
}

const { slug } = Astro.params;

const post = await client.fetch(`
  *[_type == "post" && slug.current == $slug][0] {
    _id,
    title,
    slug,
    publishedAt,
    mainImage{
      asset->{url},
      alt
    },
    body,
    excerpt
  }
`, { slug });

if (!post) {
  return Astro.redirect('/404');
}

// Convert Portable Text â†’ plain text (good reading-time)
const getPlainText = (blocks = []) =>
  blocks
    .filter((block) => block._type === 'block' && Array.isArray(block.children))
    .map((block) =>
      block.children.map((child) => child.text || '').join(' ')
    )
    .join('\n');

const plain = getPlainText(post.body || []);
const wordCount = plain.split(/\s+/).filter(Boolean).length;
const readTime = Math.max(1, Math.ceil(wordCount / 200));
---

<MainLayout
  title={post.title}
  description={post.excerpt || post.title}
>
  <div id="reading-progress" class="reading-progress"></div>

  <!-- ğŸ”¥ UPRAVENÃ PADDING â€“ obsah je nynÃ­ mnohem blÃ­Å¾e k menu -->
  <article class="max-w-5xl mx-auto px-4 pt-10 sm:pt-14 md:pt-16 pb-12 sm:pb-20">

    <!-- Breadcrumb -->
    <nav class="mb-8 text-sm animate-fade-in">
      <div class="flex items-center gap-2 text-gray-600 dark:text-gray-300">
        <a href="/" class="hover:text-purple-600 dark:hover:text-purple-400 font-medium transition-colors">ğŸ  DomÅ¯</a>
        <span class="text-gray-400 dark:text-gray-500">â†’</span>
        <a href="/blog" class="hover:text-purple-600 dark:hover:text-purple-400 font-medium transition-colors">ğŸ“ Blog</a>
        <span class="text-gray-400 dark:text-gray-500">â†’</span>
        <span class="text-gray-900 dark:text-white font-semibold">
          {post.title.length > 50 ? post.title.slice(0,50) + "â€¦" : post.title}
        </span>
      </div>
    </nav>

    <!-- Header -->
    <header class="mb-12 animate-fade-in">
      <div class="mb-6">
        <span class="inline-block px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-full text-sm font-bold shadow-lg animate-gradient">
          ğŸš€ TechnickÃ½ ÄlÃ¡nek
        </span>
      </div>

      <h1 class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-black mb-8 leading-tight">
        <span class="bg-gradient-to-r from-gray-900 via-purple-900 to-pink-900 dark:from-gray-100 dark:via-purple-300 dark:to-pink-300 bg-clip-text text-transparent">
          {post.title}
        </span>
      </h1>

      <div class="flex flex-wrap items-center gap-6 mb-8">
        <div class="flex items-center gap-2 bg-white dark:bg-gray-800 px-4 py-2 rounded-full shadow-md">
          <span class="text-2xl">ğŸ‘¤</span>
          <span class="font-semibold text-gray-900 dark:text-white">JiÅ™Ã­ VeselÃ½</span>
        </div>

        {post.publishedAt && (
          <div class="flex items-center gap-2 bg-white dark:bg-gray-800 px-4 py-2 rounded-full shadow-md">
            <span class="text-2xl">ğŸ“…</span>
            <time class="font-medium text-gray-900 dark:text-white">
              {new Date(post.publishedAt).toLocaleDateString('cs-CZ',{
                year:"numeric",
                month:"long",
                day:"numeric"
              })}
            </time>
          </div>
        )}

        <div class="flex items-center gap-2 bg-white dark:bg-gray-800 px-4 py-2 rounded-full shadow-md">
          <span class="text-2xl">â±ï¸</span>
          <span class="font-medium text-gray-900 dark:text-white">{readTime} min ÄtenÃ­</span>
        </div>
      </div>

      {post.excerpt && (
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-700 border-l-4 border-purple-600 dark:border-purple-400 p-6 rounded-r-2xl mb-8 shadow-lg">
          <p class="text-xl text-gray-700 dark:text-white font-medium">{post.excerpt}</p>
        </div>
      )}

      {post.mainImage && (
        <div class="rounded-3xl overflow-hidden shadow-2xl mb-12 border-4 border-white dark:border-gray-700 relative group">
          <img
            src={urlFor(post.mainImage).width(1200).url()}
            alt={post.mainImage.alt || post.title}
            loading="lazy"
            class="w-full object-cover transform group-hover:scale-105 transition-transform duration-700"
          />
        </div>
      )}
    </header>

    <!-- Content -->
    <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 sm:p-12 lg:p-16 shadow-2xl border border-gray-100 dark:border-gray-700 mb-12">
      <div class="prose prose-lg dark:prose-invert max-w-none">
        <PortableText value={post.body} />
      </div>
    </div>

    <!-- Back button -->
    <div class="text-center">
      <a href="/blog" class="group inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl font-bold hover:scale-110 transition-all duration-300 shadow-2xl">
        <span class="transform group-hover:-translate-x-2 transition-transform text-2xl">â†</span>
        <span>ZpÄ›t na blog</span>
      </a>
    </div>

  </article>

  <script>
    window.addEventListener('scroll', () => {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      const bar = document.getElementById('reading-progress');
      if (bar) bar.style.width = scrolled + '%';
    });
  </script>
</MainLayout>
